{% extends "base.html" %}
{% block content %}
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
    <h2 class="text-xl sm:text-2xl font-bold"><i class="fa-solid fa-user-gear text-indigo-600 mr-2"></i>User Management</h2>
    <button onclick="showAddUserModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm w-full sm:w-auto"><i class="fa-solid fa-plus mr-1"></i> New User</button>
</div>
<div class="mb-4">
    <input type="text" id="user-search" class="w-full border border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm" placeholder="Search users by name or email..." oninput="filterUsersTable()">
</div>

<!-- User Cards with Performance -->
<div id="user-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>

<!-- User Table -->
<div class="bg-white rounded-xl shadow-sm overflow-x-auto">
    <table class="w-full min-w-[600px]">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 sm:px-6 py-3 text-left text-xs sm:text-sm font-semibold text-gray-600">Username</th>
                <th class="px-4 sm:px-6 py-3 text-left text-xs sm:text-sm font-semibold text-gray-600">Role</th>
                <th class="px-4 sm:px-6 py-3 text-left text-xs sm:text-sm font-semibold text-gray-600">This Month</th>
                <th class="px-4 sm:px-6 py-3 text-left text-xs sm:text-sm font-semibold text-gray-600">Status</th>
                <th class="px-4 sm:px-6 py-3 text-left text-xs sm:text-sm font-semibold text-gray-600">Actions</th>
            </tr>
        </thead>
        <tbody id="users-table"></tbody>
    </table>
</div>
{% endblock %}
{% block modals %}
<div id="add-user-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" onclick="if(event.target===this) hideAddUserModal()">
    <div class="bg-white rounded-xl p-6 w-[90%] sm:w-96 max-w-md shadow-2xl">
        <h3 class="text-xl font-bold mb-4">New User</h3>
        <div class="mb-4"><label class="block text-gray-700 mb-2 text-sm">Username *</label><input type="text" id="new-username" class="w-full border rounded-lg px-4 py-2"></div>
        <div class="mb-4"><label class="block text-gray-700 mb-2 text-sm">Email *</label><input type="email" id="new-email" class="w-full border rounded-lg px-4 py-2"></div>
        <div class="mb-4"><label class="block text-gray-700 mb-2 text-sm">Password *</label><input type="password" id="new-password" class="w-full border rounded-lg px-4 py-2"></div>
        <div class="mb-4"><label class="block text-gray-700 mb-2 text-sm">Role</label>
            <select id="new-role" class="w-full border rounded-lg px-4 py-2"><option value="admin">Admin</option><option value="sm_specialist">SMM Specialist</option><option value="designer">Graphic Designer</option><option value="motion_designer">Motion Designer</option><option value="moderator">Account Moderator</option></select>
        </div>
        <div class="mb-4"><label class="block text-gray-700 mb-2 text-sm">Job Title</label><input type="text" id="new-job-title" class="w-full border rounded-lg px-4 py-2" placeholder="e.g. Senior Designer"></div>
        <div class="mb-4"><label class="block text-gray-700 mb-2 text-sm">Phone</label><input type="text" id="new-phone" class="w-full border rounded-lg px-4 py-2"></div>
        <div class="flex gap-4">
            <button onclick="addUser()" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Add User</button>
            <button onclick="hideAddUserModal()" class="flex-1 bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
        </div>
    </div>
</div>
<div id="edit-user-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" onclick="if(event.target===this) hideEditUserModal()">
    <div class="bg-white rounded-xl p-6 w-[90%] sm:w-96 max-w-md shadow-2xl">
        <h3 class="text-xl font-bold mb-4">Edit User</h3>
        <input type="hidden" id="edit-user-id">
        <div class="mb-4"><label class="block text-gray-700 mb-2 text-sm">Username</label><input type="text" id="edit-username" class="w-full border rounded-lg px-4 py-2"></div>
        <div class="mb-4"><label class="block text-gray-700 mb-2 text-sm">Email</label><input type="email" id="edit-email" class="w-full border rounded-lg px-4 py-2"></div>
        <div class="mb-4"><label class="block text-gray-700 mb-2 text-sm">Role</label>
            <select id="edit-role" class="w-full border rounded-lg px-4 py-2"><option value="admin">Admin</option><option value="sm_specialist">SMM Specialist</option><option value="designer">Graphic Designer</option><option value="motion_designer">Motion Designer</option><option value="moderator">Account Moderator</option></select>
        </div>
        <div class="mb-4"><label class="block text-gray-700 mb-2 text-sm">Job Title</label><input type="text" id="edit-job-title" class="w-full border rounded-lg px-4 py-2"></div>
        <div class="mb-4"><label class="block text-gray-700 mb-2 text-sm">Phone</label><input type="text" id="edit-phone" class="w-full border rounded-lg px-4 py-2"></div>
        <div class="flex gap-4">
            <button onclick="updateUser()" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Save Changes</button>
            <button onclick="hideEditUserModal()" class="flex-1 bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const roleLabels = {admin:'Admin',sm_specialist:'SMM Specialist',designer:'Graphic Designer',motion_designer:'Motion Designer',moderator:'Account Moderator'};
const roleClasses = {admin:'bg-purple-100 text-purple-800',sm_specialist:'bg-green-100 text-green-800',designer:'bg-pink-100 text-pink-800',motion_designer:'bg-orange-100 text-orange-800',moderator:'bg-blue-100 text-blue-800'};
const roleIcons = {admin:'fa-shield-halved',sm_specialist:'fa-pen-nib',designer:'fa-palette',motion_designer:'fa-film',moderator:'fa-clipboard-check'};

let usersData = [];
let userStatsData = {};

function pageInit() { loadUsers(); }

async function loadUsers() {
    const [users, stats] = await Promise.all([
        fetch(API_URL + '/users').then(r => r.json()),
        fetch(API_URL + '/users/stats').then(r => r.json()).catch(() => ({}))
    ]);
    usersData = users;
    userStatsData = stats;
    renderUserCards();
    renderUserTable();
}

function buildProgressBar(completed, required, label) {
    if (required === 0 && completed === 0) return '<span class="text-xs text-gray-400">No data</span>';
    const pct = required > 0 ? Math.min(Math.round((completed / required) * 100), 100) : 100;
    const barColor = pct >= 100 ? 'bg-green-500' : pct >= 50 ? 'bg-indigo-500' : 'bg-orange-500';
    const textColor = pct >= 100 ? 'text-green-700' : pct >= 50 ? 'text-indigo-700' : 'text-orange-700';
    return `<div class="w-full">
        <div class="flex justify-between items-center mb-1">
            <span class="text-xs font-semibold ${textColor}">${completed}${required > 0 ? ' / ' + required : ''}</span>
            <span class="text-[10px] text-gray-400">${label}</span>
        </div>
        ${required > 0 ? `<div class="w-full bg-gray-200 rounded-full h-2">
            <div class="${barColor} h-2 rounded-full transition-all" style="width:${pct}%"></div>
        </div>` : ''}
    </div>`;
}

function renderUserCards() {
    const el = document.getElementById('user-cards');
    if (!el) return;
    el.innerHTML = usersData.map(u => {
        const s = userStatsData[String(u.id)] || { completed: 0, required: 0, label: '' };
        const icon = roleIcons[u.role] || 'fa-user';
        const pct = s.required > 0 ? Math.min(Math.round((s.completed / s.required) * 100), 100) : (s.completed > 0 ? 100 : 0);
        const ringColor = pct >= 100 ? 'text-green-500' : pct >= 50 ? 'text-indigo-500' : 'text-orange-500';
        return `<div class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition">
            <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                        <i class="fa-solid ${icon} ${roleClasses[u.role]?.split(' ')[1] || 'text-gray-600'}"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-sm">${esc(u.username)}</h3>
                        <span class="text-[11px] px-2 py-0.5 rounded ${roleClasses[u.role] || 'bg-gray-100'}">${roleLabels[u.role] || u.role}</span>
                    </div>
                </div>
                <span class="px-2 py-0.5 rounded text-[10px] font-semibold ${u.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${u.is_active ? 'Active' : 'Inactive'}</span>
            </div>
            ${u.job_title ? `<p class="text-xs text-gray-500 mb-2">${esc(u.job_title)}</p>` : ''}
            <div class="mt-2">${buildProgressBar(s.completed, s.required, s.label)}</div>
        </div>`;
    }).join('');
}

function renderUserTable() {
    document.getElementById('users-table').innerHTML = usersData.map(u => {
        const s = userStatsData[String(u.id)] || { completed: 0, required: 0, label: '' };
        return `<tr class="border-t hover:bg-gray-50">
            <td class="px-4 sm:px-6 py-4">
                <div class="font-semibold">${esc(u.username)}</div>
                <div class="text-xs text-gray-400">${esc(u.email)}</div>
            </td>
            <td class="px-4 sm:px-6 py-4"><span class="px-2 py-1 rounded text-xs ${roleClasses[u.role] || 'bg-gray-100'}">${roleLabels[u.role] || u.role}</span></td>
            <td class="px-4 sm:px-6 py-4" style="min-width:160px">${buildProgressBar(s.completed, s.required, s.label)}</td>
            <td class="px-4 sm:px-6 py-4"><span class="px-2 py-1 rounded text-xs ${u.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
            <td class="px-4 sm:px-6 py-4">
                <div class="flex gap-2">
                    <button onclick="showEditUserModal(${u.id})" class="text-indigo-600 hover:underline"><i class="fa-solid fa-pen"></i></button>
                    ${u.id !== currentUser?.id ? `<button onclick="deleteUser(${u.id})" class="text-red-600 hover:underline"><i class="fa-solid fa-trash"></i></button>` : ''}
                </div>
            </td>
        </tr>`;
    }).join('');
}

function showAddUserModal() { document.getElementById('add-user-modal').classList.remove('hidden'); }
function hideAddUserModal() { document.getElementById('add-user-modal').classList.add('hidden'); }
async function addUser() {
    const data = { username: document.getElementById('new-username').value, email: document.getElementById('new-email').value, password: document.getElementById('new-password').value, role: document.getElementById('new-role').value, job_title: document.getElementById('new-job-title').value.trim(), phone: document.getElementById('new-phone').value.trim() };
    if (!data.username || !data.email || !data.password) { alert('All fields are required'); return; }
    const res = await fetch(API_URL + '/users', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(data) }).then(r => r.json());
    if (res.success) { hideAddUserModal(); loadUsers(); showToast('User added', 'success'); } else { alert('Error: ' + res.error); }
}
async function deleteUser(id) { if (confirm('Delete this user?')) { const res = await fetch(API_URL + '/users/' + id, { method: 'DELETE', credentials: 'include' }).then(r => r.json()); if (res.success) { loadUsers(); showToast('User deleted', 'success'); } else { alert('Error: ' + (res.error || 'Failed to delete')); } } }
async function showEditUserModal(id) {
    const user = usersData.find(u => u.id === id);
    if (!user) return;
    document.getElementById('edit-user-id').value = user.id;
    document.getElementById('edit-username').value = user.username || '';
    document.getElementById('edit-email').value = user.email || '';
    document.getElementById('edit-role').value = user.role || 'user';
    document.getElementById('edit-job-title').value = user.job_title || '';
    document.getElementById('edit-phone').value = user.phone || '';
    document.getElementById('edit-user-modal').classList.remove('hidden');
}
function hideEditUserModal() { document.getElementById('edit-user-modal').classList.add('hidden'); }
async function updateUser() {
    const id = document.getElementById('edit-user-id').value;
    const data = { username: document.getElementById('edit-username').value.trim(), email: document.getElementById('edit-email').value.trim(), role: document.getElementById('edit-role').value, job_title: document.getElementById('edit-job-title').value.trim(), phone: document.getElementById('edit-phone').value.trim() };
    const res = await fetch(API_URL + '/users/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(data) }).then(r => r.json());
    if (res.success) { hideEditUserModal(); loadUsers(); showToast('User updated', 'success'); } else { alert('Error: ' + (res.error || 'Update failed')); }
}
function filterUsersTable() {
    const q = (document.getElementById('user-search')?.value || '').toLowerCase();
    document.querySelectorAll('#users-table tr').forEach(row => { row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none'; });
    document.querySelectorAll('#user-cards > div').forEach(card => { card.style.display = card.textContent.toLowerCase().includes(q) ? '' : 'none'; });
}
</script>
{% endblock %}
